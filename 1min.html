<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë–¡ì¹˜ê¸°-ë¼ì§€ (1ë¶„ ìŠ¤í”„ë¦°íŠ¸)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100vh;
        }
        #timer-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 20px;
            background-color: red;
            transition: none;
        }
        #game-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding-top: 50px;
        }
        #output {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .game-button {
            width: 60px;
            height: 60px;
            font-size: 24px;
            padding: 10px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transform: scale(1.2);
            margin: 5px;
        }
        .button-1 {
            background-image: url('yellow.png');
            background-size: cover;
            background-position: center;
            border: none;
            outline: none;
            box-shadow: none;
            color: transparent;
            filter: brightness(1.1);
        }
        .button-2 {
            background-image: url('orange.png');
            background-size: cover;
            background-position: center;
            border: none;
            outline: none;
            box-shadow: none;
            color: transparent;
            filter: brightness(1.2);
        }
        .button-3 {
            background-image: url('red.png');
            background-size: cover;
            background-position: center;
            border: none;
            outline: none;
            box-shadow: none;
            color: transparent;
            filter: brightness(1.2);
        }
        .button-0 {
            background-image: url('purple.png');
            background-size: cover;
            background-position: center;
            border: none;
            outline: none;
            box-shadow: none;
            color: transparent;
            position: relative;
            left: -15px;
            filter: brightness(1.2);
        }

        .pattern {
            position: relative;
            display: inline-block;
            width: 26px;
            text-align: center;
            margin-right: 4px;
            margin-bottom: 12px;
            font-size: 0;
        }
        .pattern::after {
            content: "";
            position: absolute;
            bottom: 0px;
            left: 50%;
            transform: translateX(-50%);
            width: 34px;
            height: 34px;
            border-radius: 50%;
        }
        .pattern[data-value="1"]::after { background-image: url("yellow.png"); background-size: cover; filter: brightness(1.1); }
        .pattern[data-value="2"]::after { background-image: url("orange.png"); background-size: cover; filter: brightness(1.2); }
        .pattern[data-value="3"]::after { background-image: url("red.png"); background-size: cover; filter: brightness(1.2); }
        .pattern[data-value="0"]::after { background-image: url("purple.png"); background-size: cover; filter: brightness(1.2); }

        .correct::after {
            filter: brightness(200%);
            opacity: 0.6;
            border: 2px solid #00aa00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.8);
        }

        .correct { color: lightgray; }
        #button-container {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
        }

        #start-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 0px;
        }
        #play-count { margin-bottom: 0px; }
        #output { margin-top: 0px; }
    </style>
</head>
<body>
    <div id="timer-bar"></div>
    <h1>ë–¡ì¹˜ê¸°-ë¼ì§€ (1ë¶„ ìŠ¤í”„ë¦°íŠ¸)</h1>

    <div id="start-buttons">
        <p id="user-info">ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button id="start-button">ê²Œì„ ì‹œì‘</button>
            <button id="nickname-button">ë‹‰ë„¤ì„ ë³€ê²½</button>
            <button id="pig-button">í† ë¼</button>
        </div>
        <p id="play-count">í”Œë ˆì´ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        <p style="font-size:14px; color:#444; margin-top:8px;">60ì´ˆ ë™ì•ˆ ê°€ëŠ¥í•œ í•œ ë§ì€ íŒ¨í„´ì„ ë§ì¶”ì„¸ìš”! (í‹€ë ¤ë„ ê²Œì„ì€ ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤)</p>
    </div>

    <div id="game-container">
        <p id="output">ë­í‚¹ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        <div id="button-container" class="game-buttons"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getFirestore, setDoc, getDoc, doc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC1RCO59Qr1ogsZ1GNwxY9O2KGgMaFMyUM",
            authDomain: "mafia-5c957.firebaseapp.com",
            databaseURL: "https://mafia-5c957-default-rtdb.firebaseio.com",
            projectId: "mafia-5c957",
            storageBucket: "mafia-5c957.firebasestorage.app",
            messagingSenderId: "979859367108",
            appId: "1:979859367108:web:6f94ed2e25ca82d762d591"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ======== ê²Œì„ ìƒíƒœ ========
        const GAME_DURATION_MS = 60_000; // 60ì´ˆ
        const FIXED_PATTERN_LEN = 6;     // íŒ¨í„´ ê¸¸ì´ ê³ ì • (ë¼ìš´ë“œ ì¦ê°€ ì—†ìŒ)
        let gameActive = false;
        let timer;                // ì „ì²´ ê²Œì„ ì¢…ë£Œ íƒ€ì´ë¨¸
        let nickname = localStorage.getItem("nickname");

        let currentAnswer = "";
        let inputSequence = "";

        let patternsCleared = 0;  // ë§ì¶˜ íŒ¨í„´ ìˆ˜
        let attempts = 0;         // ì‹œë„(ì„±ê³µ+ì‹¤íŒ¨) ìˆ˜
        let mistakes = 0;         // í‹€ë¦° íŒ¨í„´ ìˆ˜

        // ë°˜ì‘ì†ë„(ì„ íƒ): ì²« ì…ë ¥ ë°˜ì‘/ì…ë ¥ ê°„ í‰ê·  ë°˜ì‘
        let reactionTimes = [];
        let firstReactionTimes = [];
        let patternStartTime;
        let lastInputTime;

        // ======== ë‹‰ë„¤ì„ ========
        function promptNickname() {
            if (!nickname) {
                nickname = prompt("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”(ë§¢ë‹‰ ê¶Œì¥):");
                if (!nickname) {
                    alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
                    return false;
                }
                localStorage.setItem("nickname", nickname);
            }
            return true;
        }

        document.getElementById("nickname-button").addEventListener("click", function () {
            let nn = prompt("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”(ë§¢ë‹‰ ê¶Œì¥):");
            if (nn) {
                nickname = nn;
                localStorage.setItem("nickname", nickname);
                alert(`ë‹‰ë„¤ì„ì´ "${nickname}"(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                loadUserInfo();
            }
        });

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("start-button").addEventListener("click", startGame);
            document.getElementById("pig-button").addEventListener("click", function () {
                window.location.href = "https://hanaida.github.io/rabbit/";
            });
        });

        // ======== ë­í‚¹/ì •ë³´ ========
        async function loadPlayCount() {
            const resultsRef = collection(db, "game_results");
            const resultsSnapshot = await getDocs(resultsRef);

            let totalCount = 0;
            resultsSnapshot.forEach((d) => { totalCount += d.data().play_count || 0; });

            document.getElementById("play-count").innerHTML =
                `ì§€ê¸ˆê¹Œì§€ <span style="color: red;">ì´ ${totalCount}íšŒ</span> í”Œë ˆì´ë˜ì—ˆìŠµë‹ˆë‹¤.`;
        }

        let rankingCache = "ë­í‚¹ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        async function loadRanking() {
            const rankingRef = collection(db, "game_results");

            // â€˜roundâ€™ í•„ë“œ = ì†Œí™”í•œ íŒ¨í„´ ìˆ˜ ë¡œ ê°„ì£¼
            const scoreQuery = query(rankingRef, orderBy("round", "desc"), limit(5));
            const scoreSnapshot = await getDocs(scoreQuery);

            const scoreRanking = scoreSnapshot.empty
                ? "ì•„ì§ ë­í‚¹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."
                : `<span style="color: red; font-weight: bold; font-size: 35px;">ë¼ì§€ì˜ ì „ë‹¹</span><br><br>
                   <span style="font-size: 20px; font-weight: bold;">ğŸ íŒ¨í„´ ìˆ˜ ë¶€ë¬¸ (1ë¶„)</span><br><br>` +
                  Array.from(scoreSnapshot.docs, (doc, index) =>
                      `${index + 1}ìœ„: ${doc.data().nickname} - ${doc.data().round} íŒ¨í„´`
                  ).join("<br>");

            rankingCache = scoreRanking + '<br><br><br><br>';
            if (!gameActive) {
                document.getElementById("output").innerHTML = rankingCache;
            }
        }

        async function loadUserInfo() {
            if (!nickname) {
                document.getElementById("user-info").innerText = "ë‹‰ë„¤ì„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.";
                return;
            }
            const userRef = doc(db, "game_results", nickname);
            const userSnap = await getDoc(userRef);

            let userBest = 0;
            let totalPlayers = 0;
            let userRank = "ë°ì´í„° ì—†ìŒ";

            if (userSnap.exists()) {
                userBest = userSnap.data().round || 0;
            }
            const rankingRef = collection(db, "game_results");
            const rankingQuery = query(rankingRef, orderBy("round", "desc"));
            const rankingSnapshot = await getDocs(rankingQuery);
            totalPlayers = rankingSnapshot.size;

            let rank = 1;
            for (const d of rankingSnapshot.docs) {
                if (d.id === nickname) { userRank = rank; break; }
                rank++;
            }

            document.getElementById("user-info").innerHTML = `
                <strong>ë‹‰ë„¤ì„:</strong> ${nickname} <br>
                <strong>ìµœê³  íŒ¨í„´ ìˆ˜(1ë¶„):</strong> ${userBest} <br>
                <strong>ë­í‚¹:</strong> ì „ì²´ ${totalPlayers}ëª… ì¤‘ <span style="color: blue;">${userRank}ë“±</span>
            `;
        }

        // ======== ì‚¬ìš´ë“œ ========
        const soundEffects = {
            "1": new Audio("sound1.mp3"),
            "2": new Audio("sound2.mp3"),
            "3": new Audio("sound3.mp3"),
            "0": new Audio("sound0.mp3")
        };
        Object.values(soundEffects).forEach(a => a.load());

        function playSound(key) {
            if (soundEffects[key]) {
                let snd = soundEffects[key].cloneNode();
                snd.play().catch(() => {});
            }
        }

        let backgroundMusic = new Audio("game-music.mp3");
        backgroundMusic.loop = true;

        // ======== ê²Œì„ ë¡œì§ ========
        function startGame() {
            if (!promptNickname()) return;
            if (gameActive) {
                alert("ì´ë¯¸ ê²Œì„ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.");
                return;
            }

            // ìƒíƒœ ì´ˆê¸°í™”
            gameActive = true;
            patternsCleared = 0;
            attempts = 0;
            mistakes = 0;
            reactionTimes = [];
            firstReactionTimes = [];
            inputSequence = "";
            currentAnswer = "";

            document.getElementById("start-buttons").style.display = "none";
            resetTimerBar();
            startGlobalTimer(GAME_DURATION_MS);

            backgroundMusic.play().catch(() => {});

            // ì²« íŒ¨í„´ ìƒì„±
            generatePattern();
            renderButtons();
            renderHUD();
        }

        function startGlobalTimer(durationMs) {
            clearTimeout(timer);
            const timerBar = document.getElementById("timer-bar");
            timerBar.style.transition = "none";
            timerBar.style.width = "100%";
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    timerBar.style.transition = `width ${durationMs}ms linear`;
                    timerBar.style.width = "0%";
                });
            });
            timer = setTimeout(endGame, durationMs);
        }

        function resetTimerBar() {
            const timerBar = document.getElementById("timer-bar");
            timerBar.style.transition = "none";
            timerBar.style.width = "100%";
        }

        // íŒ¨í„´ ê¸¸ì´ëŠ” ê³ ì •(ë¬´í•œ ìŠ¤íŠ¸ë¦¼)
        function getPatternLength() { return FIXED_PATTERN_LEN; }

        function formatPattern(pattern) {
            return pattern
                .split('')
                .map((num) => `<span class="pattern" data-value="${num}">${num}</span>`)
                .reduce((acc, curr, index) => acc + curr + ((index + 1) % 6 === 0 ? "<br>" : " "), "");
        }

        function generatePattern() {
            patternStartTime = Date.now();
            lastInputTime = null;

            const len = getPatternLength();
            // ê¸°ì¡´ ë¡œì§ ìœ ì§€: ì§ìˆ˜ ì¸ë±ìŠ¤ëŠ” ìƒ‰(1/2/3) ì¤‘ í•˜ë‚˜, í™€ìˆ˜ëŠ” 0
            const colors = ["1", "2", "3"];
            currentAnswer = Array.from({ length: len }, (_, i) =>
                (i % 2 === 0 ? colors[Math.floor(Math.random() * colors.length)] : "0")
            ).join("");

            inputSequence = "";
            document.getElementById("output").innerHTML = formatPattern(currentAnswer) + `<br>í˜„ì¬ ì ìˆ˜: ${patternsCleared}`;
        }

        function addImmediateInputEvent(button, value) {
            button.onmousedown = () => { handleInput(value); playSound(value); };
            button.ontouchstart = (e) => { e.preventDefault(); handleInput(value); playSound(value); };
        }

        function renderButtons() {
            const container = document.getElementById("button-container");
            container.innerHTML = "";

            // 3 ë²„íŠ¼ (ìœ„)
            let btnGroup = document.createElement("div");
            btnGroup.style.display = "flex";
            btnGroup.style.flexDirection = "column";
            btnGroup.style.alignItems = "center";

            let btn3Wrapper = document.createElement("div");
            btn3Wrapper.style.width = "72px";
            btn3Wrapper.style.height = "72px";
            btn3Wrapper.style.display = "flex";
            btn3Wrapper.style.justifyContent = "center";
            btn3Wrapper.style.alignItems = "center";

            let btn3 = document.createElement("button");
            btn3.innerText = "3";
            btn3.classList.add("game-button", "button-3");
            addImmediateInputEvent(btn3, "3");
            btn3Wrapper.appendChild(btn3);
            btnGroup.appendChild(btn3Wrapper);

            // 1,2 (ê°€ìš´ë°)
            let rowNumbers = document.createElement("div");
            rowNumbers.style.display = "flex";
            rowNumbers.style.gap = "20px";

            let mkBtn = (label, cls) => {
                let wrap = document.createElement("div");
                wrap.style.width = "72px";
                wrap.style.height = "72px";
                wrap.style.display = "flex";
                wrap.style.justifyContent = "center";
                wrap.style.alignItems = "center";
                const b = document.createElement("button");
                b.innerText = label;
                b.classList.add("game-button", cls);
                addImmediateInputEvent(b, label);
                wrap.appendChild(b);
                return wrap;
            };

            rowNumbers.appendChild(mkBtn("1", "button-1"));
            rowNumbers.appendChild(mkBtn("2", "button-2"));
            btnGroup.appendChild(rowNumbers);

            // 0 (ì•„ë˜)
            let rowBottom = document.createElement("div");
            rowBottom.style.display = "flex";
            rowBottom.style.alignItems = "center";
            rowBottom.style.justifyContent = "space-between";
            rowBottom.style.width = "300px";

            rowBottom.appendChild(btnGroup);

            let spacer = document.createElement("div");
            spacer.style.width = "300px";
            rowBottom.appendChild(spacer);

            let btn0Wrapper = document.createElement("div");
            btn0Wrapper.style.width = "72px";
            btn0Wrapper.style.height = "72px";
            btn0Wrapper.style.display = "flex";
            btn0Wrapper.style.justifyContent = "center";
            btn0Wrapper.style.alignItems = "center";
            btn0Wrapper.style.marginBottom = "-75px";

            let btn0 = document.createElement("button");
            btn0.innerText = "0";
            btn0.classList.add("game-button", "button-0");
            addImmediateInputEvent(btn0, "0");
            btn0Wrapper.appendChild(btn0);
            rowBottom.appendChild(btn0Wrapper);

            container.appendChild(rowBottom);
        }

        function renderHUD() {
            // í˜„ì¬ ì ìˆ˜ ë“± ì¶”ê°€ ì •ë³´ í‘œì‹œ (outputì— í•¨ê»˜ í‘œê¸°)
            const out = document.getElementById("output");
            out.innerHTML = formatPattern(currentAnswer) +
                `<br>í˜„ì¬ ì ìˆ˜: ${patternsCleared} | ì‹¤íŒ¨: ${mistakes} | ì‹œë„: ${attempts}`;
        }

        function handleInput(input) {
            if (!gameActive) return;

            const now = Date.now();
            if (!lastInputTime) {
                firstReactionTimes.push(now - patternStartTime);
            } else {
                reactionTimes.push(now - lastInputTime);
            }
            lastInputTime = now;

            inputSequence += input;

            // ì‹œê°ì  í”¼ë“œë°±
            let patternElements = document.querySelectorAll(".pattern");
            if (inputSequence.length <= patternElements.length) {
                let targetElement = patternElements[inputSequence.length - 1];
                targetElement.classList.add("correct");
            }

            // ì •ë‹µ/ì˜¤ë‹µ íŒì •
            if (inputSequence === currentAnswer) {
                // ì„±ê³µ: ì ìˆ˜ +1, ë‹¤ìŒ íŒ¨í„´ ì¦‰ì‹œ
                patternsCleared++;
                attempts++;
                document.getElementById("output").innerHTML =
                    `âœ… í†µê³¼! í˜„ì¬ ì ìˆ˜: ${patternsCleared}`;
                setTimeout(() => { generatePattern(); renderHUD(); }, 250);
            } else if (!currentAnswer.startsWith(inputSequence)) {
                // ì˜¤ë‹µ: í•´ë‹¹ íŒ¨í„´ ì‹¤íŒ¨ ì²˜ë¦¬, ë‹¤ìŒ íŒ¨í„´
                mistakes++;
                attempts++;
                document.getElementById("output").innerHTML = `âŒ ì‹¤íŒ¨! í˜„ì¬ ì ìˆ˜: ${patternsCleared}`;
                setTimeout(() => { generatePattern(); renderHUD(); }, 250);
            }
        }

        async function endGame() {
            if (!gameActive) return;
            gameActive = false;

            clearTimeout(timer);
            resetTimerBar();

            backgroundMusic.pause();
            backgroundMusic.currentTime = 0;

            // ë¦¬í¬íŠ¸
            const avgFirstReaction = firstReactionTimes.length > 0
                ? Math.floor(firstReactionTimes.reduce((a, b) => a + b, 0) / firstReactionTimes.length)
                : 0;
            const avgReaction = reactionTimes.length > 0
                ? Math.floor(reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length)
                : 0;

            document.getElementById("start-buttons").style.display = "block";
            document.getElementById("output").innerHTML = `
                ê²Œì„ ë¦¬í¬íŠ¸ (1ë¶„ ìŠ¤í”„ë¦°íŠ¸)<br><br>
                <strong>ì†Œí™” íŒ¨í„´ ìˆ˜:</strong> ${patternsCleared}<br>
                <strong>ì‹¤íŒ¨:</strong> ${mistakes} / <strong>ì‹œë„:</strong> ${attempts}<br>
                <strong>ì²« ë°˜ì‘ì†ë„ í‰ê· :</strong> ${avgFirstReaction} ms<br>
                <strong>ì…ë ¥ ê°„ í‰ê·  ì†ë„:</strong> ${avgReaction} ms
            `;

            // ì €ì¥(ìŠ¤í‚¤ë§ˆ í˜¸í™˜: round = ì†Œí™” íŒ¨í„´ ìˆ˜)
            const userRef = doc(db, "game_results", nickname);
            const userSnap = await getDoc(userRef);

            const gameRecord = {
                nickname,
                round: patternsCleared,
                play_time: new Date().toISOString(),
                first_reaction_avg: avgFirstReaction,
                reaction_avg: avgReaction,
                attempts,
                mistakes,
                mode: "1min_sprint"
            };

            if (userSnap.exists()) {
                const userData = userSnap.data();
                const updatedPlayCount = (userData.play_count || 0) + 1;
                if (patternsCleared > (userData.round || 0)) {
                    await setDoc(userRef, { ...userData, round: patternsCleared, play_count: updatedPlayCount });
                } else {
                    await setDoc(userRef, { ...userData, play_count: updatedPlayCount });
                }
            } else {
                await setDoc(userRef, { nickname, round: patternsCleared, play_count: 1 });
            }

            const historyRef = collection(db, "game_history");
            await setDoc(doc(historyRef, `${nickname}_${Date.now()}`), gameRecord);

            await loadUserInfo();
            await loadPlayCount();
            await loadRanking();
        }

        // ì´ˆê¸° ë¡œë”©
        loadRanking();
        loadUserInfo();
        loadPlayCount();
    </script>

    <footer style="position: fixed; bottom: 10px; width: 100%; text-align: center; font-size: 14px; color: black;">
        ë§Œë“ ì´ : ê°±ìƒì§ì¸
    </footer>
</body>
</html>
