<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>ë–¡ì¹˜ê¸°-ë¼ì§€ (1ë¶„)</title>
    <style>
        :root {
            /* í•œ ì¤„(ì› 34px + ì•„ë˜ ë§ˆì§„ 12px) = 46px */
            --row-shift: 46px;
        }
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100vh;
        }
        #timer-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 20px;
            background-color: red; transition: none;
        }
        #game-container {
            flex-grow: 1; display: flex; flex-direction: column;
            justify-content: flex-start; align-items: center; padding-top: 50px;
        }
        #output { font-size: 24px; font-weight: bold; margin-bottom: 20px; }

        .game-button {
            width: 60px; height: 60px; font-size: 24px; padding: 10px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; transform: scale(1.2); margin: 5px;
        }
        .button-1 { background-image: url('yellow.png'); background-size: cover; background-position: center; border: none; outline: none; box-shadow: none; color: transparent; filter: brightness(1.1); }
        .button-2 { background-image: url('orange.png'); background-size: cover; background-position: center; border: none; outline: none; box-shadow: none; color: transparent; filter: brightness(1.2); }
        .button-3 { background-image: url('red.png');    background-size: cover; background-position: center; border: none; outline: none; box-shadow: none; color: transparent; filter: brightness(1.2); }
        .button-0 { background-image: url('purple.png'); background-size: cover; background-position: center; border: none; outline: none; box-shadow: none; color: transparent; position: relative; left: -15px; filter: brightness(1.2); }

        .pattern {
            position: relative; display: inline-block; width: 26px; text-align: center;
            margin-right: 4px; margin-bottom: 12px; font-size: 0;
        }
        .pattern::after {
            content: ""; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 34px; height: 34px; border-radius: 50%;
        }
        .pattern[data-value="1"]::after { background-image: url("yellow.png"); background-size: cover; filter: brightness(1.1); }
        .pattern[data-value="2"]::after { background-image: url("orange.png"); background-size: cover; filter: brightness(1.2); }
        .pattern[data-value="3"]::after { background-image: url("red.png");    background-size: cover; filter: brightness(1.2); }
        .pattern[data-value="0"]::after { background-image: url("purple.png"); background-size: cover; filter: brightness(1.2); }

        .correct::after {
            filter: brightness(200%); opacity: 0.6; border: 2px solid #00aa00;
            box-shadow: 0 0 10px rgba(0,255,0,.8);
        }

        #button-container { position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%); }

        #start-buttons { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-top: 0; }
        #play-count { margin-bottom: 0; }
        #output { margin-top: 0; }

        /* ===== íŒ¨í„´ ë·°í¬íŠ¸ & ì• ë‹ˆë©”ì´ì…˜ ===== */
        #pattern-viewport {
            width: 100%;
            max-width: 620px;       /* ë³´ê¸° ì¢‹ê²Œ í­ ì œí•œ */
            margin: 0 auto 8px auto;
            overflow: hidden;       /* ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜ ì˜ì—­ í´ë¦¬í•‘ */
            height: calc(var(--row-shift) * 5); /* 5ì¤„ ê³ ì • */
            position: relative;
        }
        #pattern-rows {
            will-change: transform;
        }
        /* ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜: í•œ ì¤„ ìœ„ë¡œ */
        .scroll-anim {
            transform: translateY(calc(-1 * var(--row-shift)));
            transition: transform 180ms ease-out;
        }

        /* HUD ë¼ì¸(ì ìˆ˜ í‘œì‹œ) */
        #hud-line { font-size: 18px; font-weight: 600; margin-top: 6px; }
    </style>
</head>
<body>
    <div id="timer-bar"></div>
    <h1>ë–¡ì¹˜ê¸°-ë¼ì§€ (1ë¶„ Â· ì˜¤ë‹µ=ê²Œì„ì˜¤ë²„ Â· 5ì¤„ ë·°)</h1>

    <div id="start-buttons">
        <p id="user-info">ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        <div style="display:flex; justify-content:center; gap:10px;">
            <button id="start-button">ê²Œì„ ì‹œì‘</button>
            <button id="nickname-button">ë‹‰ë„¤ì„ ë³€ê²½</button>
            <button id="pig-button">í† ë¼</button>
        </div>
        <p id="play-count">í”Œë ˆì´ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        <p style="font-size:14px; color:#444; margin-top:8px;">
            60ì´ˆ ë™ì•ˆ ê°€ëŠ¥í•œ í•œ ë§ì€ <b>ì •í™•í•œ ì…ë ¥</b>ì„ í•˜ì„¸ìš”! <b>(ì˜¤ë‹µ ì‹œ ì¦‰ì‹œ ê²Œì„ì˜¤ë²„)</b><br>
            íŒ¨í„´ ê¸¸ì´ëŠ” <b>ì™„ë£Œí•œ íŒ¨í„´ 5ê°œ</b>ë§ˆë‹¤ +2ì”© ì¦ê°€í•©ë‹ˆë‹¤. (ì ìˆ˜ëŠ” <b>ì…ë ¥ 1íšŒë‹¹ +1</b>)
        </p>
    </div>

    <div id="game-container">
        <div id="output">ë­í‚¹ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <div id="button-container" class="game-buttons"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getFirestore, setDoc, getDoc, doc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC1RCO59Qr1ogsZ1GNwxY9O2KGgMaFMyUM",
            authDomain: "mafia-5c957.firebaseapp.com",
            databaseURL: "https://mafia-5c957-default-rtdb.firebaseio.com",
            projectId: "mafia-5c957",
            storageBucket: "mafia-5c957.firebasestorage.app",
            messagingSenderId: "979859367108",
            appId: "1:979859367108:web:6f94ed2e25ca82d762d591"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        /* ================= ìƒˆ ì»¬ë ‰ì…˜(ê¸°ì¡´ê³¼ ë¶„ë¦¬) ================= */
        const RESULTS_COLL = "game_results_tapscore";  // ì ìˆ˜(ì •í™• ì…ë ¥ ìˆ˜) ë­í‚¹
        const HISTORY_COLL = "game_history_tapscore";

        /* ================= ê²Œì„/ë·°í¬íŠ¸ ì„¤ì • ================= */
        const GAME_DURATION_MS = 60_000; // 60ì´ˆ
        const BASE_LEN = 1000;           // ì‹œì‘ íŒ¨í„´ ê¸¸ì´
        const INCREASE_EVERY = 5;        // ì™„ë£Œí•œ íŒ¨í„´ 5ê°œë§ˆë‹¤
        const INCREASE_STEP = 2;         // +2 ì¦ê°€

        const ROW_SIZE = 6;              // 1ì¤„ = 6ê°œ
        const VISIBLE_ROWS = 5;          // í•­ìƒ 5ì¤„ë§Œ ë³´ì—¬ì¤Œ
        const SCROLL_MS = 180;           // ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„(ms)

        /* ================= ìƒíƒœ ================= */
        let uiState = "menu";            // "menu" | "playing" | "report"
        let gameActive = false;
        let timer;
        let nickname = localStorage.getItem("nickname");

        // ì§„í–‰ìƒíƒœ
        let currentAnswer = "";
        let inputSequence = "";

        // ì ìˆ˜/í†µê³„
        let score = 0;                 // âœ… ì •í™• ì…ë ¥ ìˆ˜(=ë­í‚¹ ì§€í‘œ)
        let completedPatterns = 0;     // ê¸¸ì´ ì¦ê°€ ê·œì¹™ìš©

        let reactionTimes = [];        // ì…ë ¥ ê°„ ê°„ê²©(ms)
        let firstReactionTimes = [];   // ê° íŒ¨í„´ ì²« ë°˜ì‘(ms)
        let patternStartTime;
        let lastInputTime;

        // ë·°í¬íŠ¸
        let viewportStartRow = 0;      // í˜„ì¬ ë³´ì´ëŠ” ì²« ì¤„ ì¸ë±ìŠ¤

        /* ================= ë‹‰ë„¤ì„ ================= */
        function promptNickname() {
            if (!nickname) {
                nickname = prompt("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”(ë§¢ë‹‰ ê¶Œì¥):");
                if (!nickname) { alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤."); return false; }
                localStorage.setItem("nickname", nickname);
            }
            return true;
        }

        document.getElementById("nickname-button").addEventListener("click", () => {
            const nn = prompt("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”(ë§¢ë‹‰ ê¶Œì¥):");
            if (nn) {
                nickname = nn;
                localStorage.setItem("nickname", nickname);
                alert(`ë‹‰ë„¤ì„ì´ "${nickname}"(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                loadUserInfo();
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("start-button").addEventListener("click", startGame);
            document.getElementById("pig-button").addEventListener("click", () => {
                window.location.href = "https://hanaida.github.io/rabbit/";
            });
        });

        /* ================= ë­í‚¹/ì •ë³´ ================= */
        async function loadPlayCount() {
            const resultsRef = collection(db, RESULTS_COLL);
            const resultsSnapshot = await getDocs(resultsRef);
            let totalCount = 0;
            resultsSnapshot.forEach(d => totalCount += d.data().play_count || 0);
            document.getElementById("play-count").innerHTML = `ì§€ê¸ˆê¹Œì§€ <span style="color:red;">ì´ ${totalCount}íšŒ</span> í”Œë ˆì´ë˜ì—ˆìŠµë‹ˆë‹¤.`;
        }

        let rankingCache = "ë­í‚¹ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        async function loadRanking() {
            const rankingRef = collection(db, RESULTS_COLL);
            const scoreQuery = query(rankingRef, orderBy("score", "desc"), limit(5));
            const scoreSnapshot = await getDocs(scoreQuery);

            const scoreRanking = scoreSnapshot.empty
                ? "ì•„ì§ ë­í‚¹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."
                : `<span style="color:red; font-weight:bold; font-size:35px;">ë¼ì§€ì˜ ì „ë‹¹</span><br><br>
                   <span style="font-size:20px; font-weight:bold;">ğŸ ì ìˆ˜(ì •í™• ì…ë ¥ ìˆ˜) ë¶€ë¬¸ (1ë¶„)</span><br><br>` +
                  Array.from(scoreSnapshot.docs, (doc, i) =>
                      `${i + 1}ìœ„: ${doc.data().nickname} - ${doc.data().score} ì `
                  ).join("<br>");

            rankingCache = scoreRanking + '<br><br><br><br>';

            // â—ë¦¬í¬íŠ¸ í™”ë©´ì„ ë®ì–´ì“°ì§€ ì•Šë„ë¡: ë©”ë‰´ ìƒíƒœì—ì„œë§Œ ì¶œë ¥
            if (uiState === "menu") {
                const out = document.getElementById("output");
                out.innerHTML = rankingCache;
            }
        }

        async function loadUserInfo() {
            if (!nickname) { document.getElementById("user-info").innerText = "ë‹‰ë„¤ì„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”."; return; }

            const userRef = doc(db, RESULTS_COLL, nickname);
            const userSnap = await getDoc(userRef);

            let userBest = 0;
            let totalPlayers = 0;
            let userRank = "ë°ì´í„° ì—†ìŒ";

            if (userSnap.exists()) userBest = userSnap.data().score || 0;

            const rankingRef = collection(db, RESULTS_COLL);
            const rankingQuery = query(rankingRef, orderBy("score", "desc"));
            const rankingSnapshot = await getDocs(rankingQuery);
            totalPlayers = rankingSnapshot.size;

            let rank = 1;
            for (const d of rankingSnapshot.docs) {
                if (d.id === nickname) { userRank = rank; break; }
                rank++;
            }

            document.getElementById("user-info").innerHTML =
                `<strong>ë‹‰ë„¤ì„:</strong> ${nickname} <br>
                 <strong>ìµœê³  ì ìˆ˜(1ë¶„):</strong> ${userBest} <br>
                 <strong>ë­í‚¹:</strong> ì „ì²´ ${totalPlayers}ëª… ì¤‘ <span style="color:blue;">${userRank}ë“±</span>`;
        }

        /* ================= ì‚¬ìš´ë“œ(ì„ íƒ) ================= */
        const soundEffects = {
            "1": new Audio("sound1.mp3"),
            "2": new Audio("sound2.mp3"),
            "3": new Audio("sound3.mp3"),
            "0": new Audio("sound0.mp3")
        };
        Object.values(soundEffects).forEach(a => a.load());
        function playSound(key) {
            const s = soundEffects[key];
            if (s) s.cloneNode().play().catch(()=>{});
        }
        const backgroundMusic = new Audio("game-music.mp3");
        backgroundMusic.loop = true;

        /* ================= ê³µí†µ ë Œë”ë§ ìœ í‹¸ ================= */
        function ensureViewportStructure() {
            const out = document.getElementById("output");
            if (!document.getElementById("pattern-viewport")) {
                out.innerHTML =
                    `<div id="pattern-viewport"><div id="pattern-rows"></div></div>
                     <div id="hud-line"></div>`;
            }
        }

        function formatPatternWindow(answer, typedLen) {
            const startIdx = viewportStartRow * ROW_SIZE;
            const endIdx = Math.min(answer.length, startIdx + VISIBLE_ROWS * ROW_SIZE);
            let html = "";
            for (let i = startIdx; i < endIdx; i++) {
                const ch = answer[i];
                const wasTyped = i < typedLen;
                html += `<span class="pattern${wasTyped ? " correct" : ""}" data-value="${ch}">${ch}</span>`;
                if ((i - startIdx + 1) % ROW_SIZE === 0) html += "<br>";
                else html += " ";
            }
            return html;
        }

        function renderHUD() {
            ensureViewportStructure();
            const rowsEl = document.getElementById("pattern-rows");
            const hudEl  = document.getElementById("hud-line");

            rowsEl.innerHTML = formatPatternWindow(currentAnswer, inputSequence.length);

            const avgReaction = reactionTimes.length
                ? Math.floor(reactionTimes.reduce((a,b)=>a+b,0) / reactionTimes.length)
                : 0;
            hudEl.textContent = `ì ìˆ˜: ${score} Â· í‰ê·  ì…ë ¥ ì†ë„: ${avgReaction} ms`;
        }

        /* ================= ê²Œì„ ë¡œì§ ================= */
        function startGame() {
            if (!promptNickname()) return;
            if (gameActive) { alert("ì´ë¯¸ ê²Œì„ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤."); return; }

            uiState = "playing";
            gameActive = true;

            score = 0;
            completedPatterns = 0;
            reactionTimes = [];
            firstReactionTimes = [];
            inputSequence = "";
            currentAnswer = "";
            viewportStartRow = 0;

            document.getElementById("start-buttons").style.display = "none";
            resetTimerBar();
            startGlobalTimer(GAME_DURATION_MS);

            backgroundMusic.play().catch(()=>{});
            generatePattern();
            renderButtons();
            renderHUD();
        }

        function startGlobalTimer(ms) {
            clearTimeout(timer);
            const bar = document.getElementById("timer-bar");
            bar.style.transition = "none"; bar.style.width = "100%";
            requestAnimationFrame(()=>requestAnimationFrame(()=>{
                bar.style.transition = `width ${ms}ms linear`;
                bar.style.width = "0%";
            }));
            timer = setTimeout(()=>endGame(false), ms);
        }

        function resetTimerBar() {
            const bar = document.getElementById("timer-bar");
            bar.style.transition = "none"; bar.style.width = "100%";
        }

        function getPatternLength() {
            return BASE_LEN + Math.floor(completedPatterns / INCREASE_EVERY) * INCREASE_STEP;
        }

        function generatePattern() {
            patternStartTime = Date.now();
            lastInputTime = null;

            const len = getPatternLength();
            const colors = ["1", "2", "3"];
            currentAnswer = Array.from({length: len}, (_,i)=>
                (i % 2 === 0 ? colors[Math.floor(Math.random()*colors.length)] : "0")
            ).join("");

            inputSequence = "";
            viewportStartRow = 0;

            renderHUD();
        }

        function addImmediateInputEvent(button, value) {
            button.onmousedown = () => { handleInput(value); playSound(value); };
            button.ontouchstart = (e) => { e.preventDefault(); handleInput(value); playSound(value); };
        }

        function renderButtons() {
            const container = document.getElementById("button-container");
            container.innerHTML = "";

            // ìœ„: 3
            const group = document.createElement("div");
            group.style.display = "flex"; group.style.flexDirection = "column"; group.style.alignItems = "center";

            const makeWrap = () => {
                const w = document.createElement("div");
                w.style.width="72px"; w.style.height="72px";
                w.style.display="flex"; w.style.justifyContent="center"; w.style.alignItems="center";
                return w;
            };

            const w3 = makeWrap();
            const b3 = document.createElement("button");
            b3.innerText="3"; b3.classList.add("game-button","button-3");
            addImmediateInputEvent(b3,"3");
            w3.appendChild(b3); group.appendChild(w3);

            // ê°€ìš´ë°: 1,2
            const rowMid = document.createElement("div");
            rowMid.style.display="flex"; rowMid.style.gap="20px";

            const mkBtn = (label, cls) => {
                const wrap = makeWrap();
                const b = document.createElement("button");
                b.innerText = label; b.classList.add("game-button", cls);
                addImmediateInputEvent(b, label);
                wrap.appendChild(b);
                return wrap;
            };
            rowMid.appendChild(mkBtn("1","button-1"));
            rowMid.appendChild(mkBtn("2","button-2"));
            group.appendChild(rowMid);

            // ì•„ë˜: 0 (ì˜¤ë¥¸ìª½)
            const bottom = document.createElement("div");
            bottom.style.display="flex"; bottom.style.alignItems="center";
            bottom.style.justifyContent="space-between"; bottom.style.width="300px";

            bottom.appendChild(group);

            const spacer = document.createElement("div");
            spacer.style.width="300px";
            bottom.appendChild(spacer);

            const w0 = makeWrap();
            w0.style.marginBottom="-75px";
            const b0 = document.createElement("button");
            b0.innerText="0"; b0.classList.add("game-button","button-0");
            addImmediateInputEvent(b0,"0");
            w0.appendChild(b0);
            bottom.appendChild(w0);

            container.appendChild(bottom);
        }

        function handleInput(input) {
            if (!gameActive) return;

            const now = Date.now();
            if (!lastInputTime) {
                firstReactionTimes.push(now - patternStartTime);
            } else {
                reactionTimes.push(now - lastInputTime);
            }
            lastInputTime = now;

            const nextSeq = inputSequence + input;

            // ì˜¤ë‹µ ì¦‰ì‹œ ì¢…ë£Œ
            if (!currentAnswer.startsWith(nextSeq)) { endGame(true); return; }

            // ì •ë‹µ 1íšŒ ì…ë ¥ â†’ ì ìˆ˜ +1
            inputSequence = nextSeq;
            score += 1;

            // í•œ ì¤„(6ê°œ) ì™„ë£Œ ì‹œ: ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜ â†’ ì™„ë£Œ í›„ ì‹¤ì œë¡œ í•œ ì¤„ ì˜¬ë¦¼
            if (inputSequence.length % ROW_SIZE === 0 && inputSequence.length < currentAnswer.length) {
                ensureViewportStructure();
                const rowsEl = document.getElementById("pattern-rows");
                // ì¼ë‹¨ í˜„ì¬ ìƒíƒœ ë Œë”
                rowsEl.innerHTML = formatPatternWindow(currentAnswer, inputSequence.length);
                // ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ë¶€ì—¬
                rowsEl.classList.remove("scroll-anim"); // ì¬ì‚¬ìš© ëŒ€ë¹„ ë¦¬ì…‹
                void rowsEl.offsetWidth;               // reflow ê°•ì œ(í´ë˜ìŠ¤ ì¬ì ìš© íŠ¸ë¦­)
                rowsEl.classList.add("scroll-anim");

                // ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚œ ë’¤ ì‹¤ì œ ë·°í¬íŠ¸ ì´ë™ + ì¬ë Œë”
                setTimeout(() => {
                    viewportStartRow++;
                    rowsEl.classList.remove("scroll-anim");
                    renderHUD();
                }, SCROLL_MS);
            } else {
                renderHUD();
            }

            // íŒ¨í„´ ì „ì²´ ì™„ë£Œ â†’ ê¸¸ì´ ì¦ê°€ ì¹´ìš´í„°ë§Œ +1 í›„ ìƒˆ íŒ¨í„´
            if (inputSequence.length === currentAnswer.length) {
                completedPatterns += 1;
                setTimeout(() => { generatePattern(); }, 120);
            }
        }

        async function endGame(byMistake = false) {
            if (!gameActive) return;

            gameActive = false;
            uiState = "report";                 // â—ë¦¬í¬íŠ¸ ëª¨ë“œë¡œ ì „í™˜(ë­í‚¹ì´ ë®ì–´ì“°ì§€ ì•Šë„ë¡)

            clearTimeout(timer);
            resetTimerBar();

            try { if (byMistake) new Audio("game-over.mp3").play().catch(()=>{}); } catch(e){}

            backgroundMusic.pause();
            backgroundMusic.currentTime = 0;

            const avgReaction = reactionTimes.length
                ? Math.floor(reactionTimes.reduce((a,b)=>a+b,0) / reactionTimes.length)
                : 0;

            // ìŠ¤íƒ€íŠ¸ ë²„íŠ¼ ì˜ì—­ì€ ë‹¤ì‹œ ë³´ì´ë˜, outputì€ ë¦¬í¬íŠ¸ ê³ ì •
            document.getElementById("start-buttons").style.display = "block";

            const out = document.getElementById("output");
            out.innerHTML =
                `<div style="margin:8px 0 4px 0; font-size:22px; font-weight:700;">ê²Œì„ ë¦¬í¬íŠ¸ (1ë¶„)</div>
                 <div style="font-size:18px; line-height:1.7;">
                    <strong>ì ìˆ˜:</strong> ${score}<br>
                    <strong>í‰ê·  ì…ë ¥ ì†ë„:</strong> ${avgReaction} ms
                 </div>`;

            // ===== ì €ì¥(ì ìˆ˜ ê¸°ì¤€, ë¦¬í¬íŠ¸ëŠ” ìœ ì§€ / ë­í‚¹ì€ ìºì‹œë§Œ ê°±ì‹ ) =====
            if (nickname) {
                const userRef = doc(db, RESULTS_COLL, nickname);
                const userSnap = await getDoc(userRef);

                const gameRecord = {
                    nickname,
                    score,                             // âœ… ë­í‚¹ ì§€í‘œ
                    completed_patterns: completedPatterns,
                    play_time: new Date().toISOString(),
                    reaction_avg: avgReaction,
                    last_pattern_length: getPatternLength(),
                    mode: "1min_tapscore_scrolling5rows",
                    end_reason: byMistake ? "mistake" : "timeup"
                };

                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    const updatedPlayCount = (userData.play_count || 0) + 1;
                    if (score > (userData.score || 0)) {
                        await setDoc(userRef, { ...userData, score, completed_patterns: Math.max(completedPatterns, userData.completed_patterns || 0), play_count: updatedPlayCount });
                    } else {
                        await setDoc(userRef, { ...userData, play_count: updatedPlayCount, completed_patterns: Math.max(completedPatterns, userData.completed_patterns || 0) });
                    }
                } else {
                    await setDoc(userRef, { nickname, score, completed_patterns: completedPatterns, play_count: 1 });
                }

                const historyRef = collection(db, HISTORY_COLL);
                await setDoc(doc(historyRef, `${nickname}_${Date.now()}`), gameRecord);
            }

            // ì‚¬ìš©ì ì •ë³´/í”Œë ˆì´ ì¹´ìš´íŠ¸ëŠ” ê°±ì‹ í•˜ë˜,
            // ë­í‚¹ì€ í™”ë©´ì— ì¦‰ì‹œ ë°˜ì˜í•˜ì§€ ì•Šê³  ìºì‹œë§Œ ì—…ë°ì´íŠ¸(í™”ë©´ ë®ì–´ì“°ê¸° ë°©ì§€).
            await loadUserInfo();
            await loadPlayCount();
            loadRanking(); // uiStateê°€ "report"ë¼ì„œ í™”ë©´ ë¯¸ì¶œë ¥, ìºì‹œë§Œ ê°±ì‹ 
        }

        /* ================= ì´ˆê¸° ë¡œë”© ================= */
        function showMenu() {
            uiState = "menu";
            const out = document.getElementById("output");
            out.innerHTML = rankingCache;
        }

        // ì²˜ìŒì—” ë©”ë‰´ ìƒíƒœë¡œ ë­í‚¹ ë Œë”
        showMenu();
        loadRanking();
        loadUserInfo();
        loadPlayCount();
    </script>

    <footer style="position: fixed; bottom: 10px; width: 100%; text-align: center; font-size: 14px; color: black;">
        ë§Œë“ ì´ : ê°±ìƒì§ì¸
    </footer>
</body>
</html>
