<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>떡치기</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100vh;
        }
        #timer-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 20px;
            background-color: red;
            transition: none;
        }
        #game-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding-top: 50px;
        }
        #output {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .game-buttons {
            display: flex;
            flex-wrap: nowrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .button-1 {
    background-color: yellow;
    color: black;
    border: none;
}

.button-2 {
    background-color: orange;
    color: white;
    border: none;
}

.button-3 {
    background-color: red;
    color: white;
    border: none;
}

.button-0 {
    background-color: purple;
    color: white;
    border: none;
}
.pattern {
    position: relative;
    display: inline-block;
    width: 26px; /* 기존 24px → 26px (좌우 간격 증가) */
    text-align: center;
    margin-right: 4px; /* 숫자 사이 간격 증가 */
    margin-bottom: 12px; /* 기존보다 약간만 아래쪽 간격 증가 */
    font-size: 0;
}

.pattern::after {
    content: "";
    position: absolute;
    bottom: 0px; /* 숫자 자리에 배치 */
    left: 50%;
    transform: translateX(-50%);
    width: 34px;  /* 작은 원 크기 */
    height: 34px;
    border-radius: 50%; /* 원형 */
}

/* 숫자별 원 색상 지정 */
.pattern[data-value="1"]::after {
    background-color: yellow;
}
.pattern[data-value="2"]::after {
    background-color: orange;
}
.pattern[data-value="3"]::after {
    background-color: red;
}
.pattern[data-value="0"]::after {
    background-color: purple;
}
/* 기존 스타일에 추가 */
.correct::after {
    filter: brightness(200%); /* 색상을 더 밝게 */
    opacity: 0.6; /* 투명도를 살짝 낮춰서 연하게 */
}

        .game-button {
    width: 60px; /* 기존 60px → 80px */
    height: 60px; /* 기존 60px → 80px */
    font-size: 24px; /* 기존 24px → 28px */
    padding: 10px; /* 기존 10px → 15px */
    border-radius: 50%; /* 원형 유지 */
    display: flex;
    justify-content: center;
    align-items: center;
}
        .correct {
            color: lightgray;
        }
        #button-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }
        #start-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="timer-bar"></div>
    <h1>떡치기</h1>

    <div id="start-buttons">
    <p id="user-info">사용자 정보를 불러오는 중...</p>
    <button onclick="startGame()">게임 시작</button>
    </div>
    
    <div id="game-container">
        <p id="output">랭킹 불러오는 중...</p>
        <div id="button-container" class="game-buttons"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getFirestore, setDoc, getDoc, doc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC1RCO59Qr1ogsZ1GNwxY9O2KGgMaFMyUM",
            authDomain: "mafia-5c957.firebaseapp.com",
            databaseURL: "https://mafia-5c957-default-rtdb.firebaseio.com",
            projectId: "mafia-5c957",
            storageBucket: "mafia-5c957.firebasestorage.app",
            messagingSenderId: "979859367108",
            appId: "1:979859367108:web:6f94ed2e25ca82d762d591"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let gameActive = false;
        let round = 0;
        let currentAnswer = "";
        let inputSequence = "";
        let colorsPig = ["1", "2", "3"];
        let timer;
        let nickname = localStorage.getItem("nickname");

        function promptNickname() {
            if (!nickname) {
                nickname = prompt("닉네임을 입력하세요:");
                if (!nickname) {
                    alert("닉네임을 입력해야 합니다.");
                    return false;
                }
                localStorage.setItem("nickname", nickname);
            }
            return true;
        }

        let rankingCache = "랭킹 불러오는 중..."; // 랭킹을 임시로 저장하는 변수

async function loadRanking() {
    const rankingRef = collection(db, "game_results");
    const rankingQuery = query(rankingRef, orderBy("round", "desc"), limit(5));
    const rankingSnapshot = await getDocs(rankingQuery);

    rankingCache = rankingSnapshot.empty 
        ? "아직 랭킹 정보가 없습니다."
        : `<span style="color: red; font-weight: bold; font-size: 35px;">명예의 전당</span><br>
           <span style="color: black; font-size: 12px;">랭킹 보상(일요일 지급) - 1위 : 깜주 2-3위 : 깜엽 4-5위 : 주엽</span><br><br>` + 
        Array.from(rankingSnapshot.docs, (doc, index) => 
            `${index + 1}위: ${doc.data().nickname} - ${doc.data().round} round`
        ).join("<br>");

    if (!gameActive) {
        document.getElementById("output").innerHTML = rankingCache;
    }
}



// 효과음 파일 경로 설정
const soundEffects = {
    "1": new Audio("sound1.mp3"),
    "2": new Audio("sound2.mp3"),
    "3": new Audio("sound3.mp3"),
    "0": new Audio("sound0.mp3")
};



// 모든 오디오 파일이 로드되도록 설정
Object.values(soundEffects).forEach(audio => {
    audio.load(); // 오디오 미리 로드
});

        
// 효과음 중첩 재생을 위해 새로운 오디오 객체를 생성하는 함수
// 효과음을 빠르게 재생하기 위한 함수
function playSound(soundKey) {
    if (soundEffects[soundKey]) {
        let soundClone = soundEffects[soundKey].cloneNode(); // 새로운 인스턴스 생성
        soundClone.play().catch(error => console.log("오디오 재생 오류:", error));
    }
}

// 버튼에 즉시 입력 및 효과음 재생 이벤트 추가



async function loadUserInfo() {
    if (!nickname) {
        document.getElementById("user-info").innerText = "닉네임을 설정해주세요.";
        return;
    }

    const userRef = doc(db, "game_results", nickname);
    const userSnap = await getDoc(userRef);
    
    let userRound = 0;
    let totalPlayers = 0;
    let userRank = "데이터 없음";

    // 유저 최고 라운드 가져오기
    if (userSnap.exists()) {
        userRound = userSnap.data().round;
    }

    // 전체 유저 랭킹 가져오기
    const rankingRef = collection(db, "game_results");
    const rankingQuery = query(rankingRef, orderBy("round", "desc"));
    const rankingSnapshot = await getDocs(rankingQuery);

    totalPlayers = rankingSnapshot.size;

    let rank = 1;
    for (const doc of rankingSnapshot.docs) {
        if (doc.id === nickname) {
            userRank = rank;
            break;
        }
        rank++;
    }

    document.getElementById("user-info").innerHTML = `
        <strong>닉네임:</strong> ${nickname} <br>
        <strong>최고 라운드:</strong> ${userRound} <br>
        <strong>랭킹:</strong> 전체 ${totalPlayers}명 중 <span style="color: blue;">${userRank}등</span>
    `;
}





async function loadUserRecord() {
    if (!nickname) return; // 닉네임이 없으면 실행 안 함

    const userRef = doc(db, "game_results", nickname);
    const userSnap = await getDoc(userRef);

    if (userSnap.exists()) {
        const userData = userSnap.data();
        document.getElementById("user-info").innerHTML = 
            `닉네임: <b>${nickname}</b><br>최고 라운드: <b>${userData.round}</b>`;
    } else {
        document.getElementById("user-info").innerHTML = 
            `닉네임: <b>${nickname}</b><br>최고 라운드: <b>기록 없음</b>`;
    }
}




        
        
        let backgroundMusic = new Audio("game-music.mp3"); // 오디오 파일 로드
backgroundMusic.loop = true; // 반복 재생 설정

function startGame() {
    if (!promptNickname()) return;
    if (gameActive) {
        alert("이미 게임이 진행 중입니다.");
        return;
    }

    gameActive = true;
    round = 0;
    inputSequence = "";
    document.getElementById("start-buttons").style.display = "none";
    generateQuestion();

    // 게임이 시작될 때 음악 재생
    backgroundMusic.play().catch(error => {
        console.log("자동 재생이 차단됨. 유저 입력 후 재생 필요", error);
    });
    
   // 사용자 기록 업데이트
    loadUserRecord();
    loadUserInfo();
}

// 페이지 로드 시 랭킹 & 사용자 기록 불러오기
loadRanking();
loadUserInfo();

        function getPatternLength() {
            return 6 + Math.floor(round / 5) * 2;
        }

        function formatPattern(pattern) {
    return pattern
        .split('')
        .map((num) => `<span class="pattern" data-value="${num}">${num}</span>`)
        .reduce((acc, curr, index) => acc + curr + ((index + 1) % 6 === 0 ? "<br>" : " "), "");
}

        let reactionTimes = [];
let firstReactionTimes = [];
let roundStartTime;
let lastInputTime;

/**
 * 반응속도 기록을 초기화하고 새로운 라운드를 시작할 때 시간을 저장
 */
function generateQuestion() {
    clearTimeout(timer);
    resetTimerBar();
    
    roundStartTime = Date.now(); // 라운드 시작 시간 저장
    lastInputTime = null; // 마지막 입력 시간 초기화
    
    let length = getPatternLength();
    currentAnswer = Array.from({ length: length }, (_, i) => 
        (i % 2 === 0 ? colorsPig[Math.floor(Math.random() * colorsPig.length)] : "0")
    ).join("");

    document.getElementById("output").innerHTML = formatPattern(currentAnswer);
    inputSequence = "";
    renderButtons();
    startTimer();
}

        function renderButtons() {
    let container = document.getElementById("button-container");
    container.innerHTML = "";

    let buttonMap = {};

    // 버튼 컨테이너 스타일 설정
    container.style.display = "flex";
    container.style.flexDirection = "column";
    container.style.alignItems = "center";

    // 3 버튼을 포함하는 그룹
    let btnGroup = document.createElement("div");
    btnGroup.style.display = "flex";
    btnGroup.style.flexDirection = "column";
    btnGroup.style.alignItems = "center";

    let btn3 = document.createElement("button");
    btn3.innerText = "3";
    btn3.classList.add("game-button", "button-3");
    addImmediateInputEvent(btn3, "3");
    buttonMap["3"] = btn3;

    btnGroup.appendChild(btn3);

    // 1과 2 버튼을 포함하는 그룹
    let rowNumbers = document.createElement("div");
    rowNumbers.style.display = "flex";
    rowNumbers.style.justifyContent = "space-between";
    rowNumbers.style.width = "120px"; // 1과 2 버튼 간격 조정

    let btn1 = document.createElement("button");
    btn1.innerText = "1";
    btn1.classList.add("game-button", "button-1");
    addImmediateInputEvent(btn1, "1");
    buttonMap["1"] = btn1;

    let btn2 = document.createElement("button");
    btn2.innerText = "2";
    btn2.classList.add("game-button", "button-2");
    addImmediateInputEvent(btn2, "2");
    buttonMap["2"] = btn2;

    rowNumbers.appendChild(btn1);
    rowNumbers.appendChild(btn2);
    btnGroup.appendChild(rowNumbers);

    // 하단 0 버튼을 포함하는 그룹
    let rowBottom = document.createElement("div");
    rowBottom.style.display = "flex";
    rowBottom.style.alignItems = "center";
    rowBottom.style.justifyContent = "space-between";
    rowBottom.style.width = "250px"; // 1,2와 0 사이 간격을 넓힘

    rowBottom.appendChild(btnGroup); // 3, 1, 2 버튼 그룹 추가

    let spacer = document.createElement("div");
    spacer.style.width = "80px"; // 1,2와 0 사이 간격 조절
    rowBottom.appendChild(spacer);

    let btn0 = document.createElement("button");
    btn0.innerText = "0";
    btn0.classList.add("game-button", "button-0");
    addImmediateInputEvent(btn0, "0");
    buttonMap["0"] = btn0;

    rowBottom.appendChild(btn0);
    
    container.appendChild(rowBottom);
}

/**
 * 버튼을 누르자마자 입력되도록 이벤트 추가하는 함수
 * @param {HTMLElement} button 버튼 요소
 * @param {string} value 입력할 숫자
 */
function addImmediateInputEvent(button, value) {
    button.onmousedown = () => {
        handleInput(value);
        playSound(value); // 버튼 클릭 시 효과음 즉시 재생
    };
    button.ontouchstart = (e) => {
        e.preventDefault(); // 모바일에서 터치 중복 실행 방지
        handleInput(value);
        playSound(value);
    };
}



        /**
 * 버튼을 누를 때 반응속도 측정
 */
let nextRoundPending = false; // 새로운 변수 추가

function handleInput(input) {
    if (!gameActive || nextRoundPending) return; // '통과!' 상태일 때 입력 차단

    let currentTime = Date.now();
    if (!lastInputTime) {
        firstReactionTimes.push(currentTime - roundStartTime);
    } else {
        reactionTimes.push(currentTime - lastInputTime);
    }
    lastInputTime = currentTime;

    inputSequence += input;

    let patternElements = document.querySelectorAll(".pattern");
    if (inputSequence.length <= patternElements.length) {
        let targetElement = patternElements[inputSequence.length - 1];
        targetElement.classList.add("correct");
    }

    if (inputSequence === currentAnswer) {
        clearTimeout(timer);
        round++;

        // 첫 반응속도 및 평균 반응속도 계산
        let firstReaction = firstReactionTimes[firstReactionTimes.length - 1] || 0;
        let avgReaction = reactionTimes.length > 0 ? 
            Math.floor(reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length) : 0;

        document.getElementById("output").innerHTML = `통과! Round: ${round}<br>
            첫 반응속도: ${firstReaction} ms<br>
            평균속도: ${avgReaction} ms`;

        nextRoundPending = true; // 통과 메시지 표시 중 입력 차단

        setTimeout(() => {
            nextRoundPending = false; // 새로운 라운드 시작 전 입력 허용
            generateQuestion();
        }, 1000);
    } else if (!currentAnswer.startsWith(inputSequence)) {
        gameOver();
    }
}

        function startTimer() {
            let timerBar = document.getElementById("timer-bar");
            clearTimeout(timer);
            resetTimerBar();

            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    timerBar.style.transition = "width 5s linear";
                    timerBar.style.width = "0%";
                });
            });

            timer = setTimeout(gameOver, 5000);
        }

        function resetTimerBar() {
            let timerBar = document.getElementById("timer-bar");
            timerBar.style.transition = "none";
            timerBar.style.width = "100%";
        }

        /**
 * 게임 종료 후 반응속도 평균 계산 및 리포트 표시
 */
async function gameOver() {
    if (!gameActive) return;

    gameActive = false;
    clearTimeout(timer);

    // 배경 음악 중지
    backgroundMusic.pause();
    backgroundMusic.currentTime = 0;

    // 게임 오버 효과음 재생 (한 번만)
    let gameOverSound = new Audio("game-over.mp3");
    gameOverSound.play().catch(error => console.log("게임 오버 효과음 재생 오류:", error));

    document.getElementById("output").innerHTML = rankingCache;
    document.getElementById("start-buttons").style.display = "block";
    resetTimerBar();

    let avgFirstReaction = firstReactionTimes.length > 0 ? 
        Math.floor(firstReactionTimes.reduce((a, b) => a + b, 0) / firstReactionTimes.length) : 0;
    let avgReaction = reactionTimes.length > 0 ? 
        Math.floor(reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length) : 0;

    document.getElementById("output").innerHTML = `
        게임 리포트<br><br>
        <strong>도달 라운드:</strong> ${round}<br>
        <strong>첫 반응속도:</strong> ${avgFirstReaction} ms<br>
        <strong>평균속도:</strong> ${avgReaction} ms
    `;

    const userRef = doc(db, "game_results", nickname);
    const userSnap = await getDoc(userRef);

    const gameRecord = {
        nickname,
        round,
        play_time: new Date().toISOString(),
        first_reaction_avg: avgFirstReaction,
        reaction_avg: avgReaction
    };

    if (userSnap.exists()) {
        const userData = userSnap.data();
        const updatedPlayCount = (userData.play_count || 0) + 1;

        if (round > userData.round) {
            await setDoc(userRef, { ...userData, round, play_count: updatedPlayCount });
        } else {
            await setDoc(userRef, { ...userData, play_count: updatedPlayCount });
        }
    } else {
        await setDoc(userRef, { nickname, round, play_count: 1 });
    }

    const historyRef = collection(db, "game_history");
    await setDoc(doc(historyRef, `${nickname}_${Date.now()}`), gameRecord);

    await loadUserInfo();
}
        window.startGame = startGame;

        // 페이지 로드 시 랭킹 불러오기
        loadRanking();
    </script>
</body>
<footer style="position: fixed; bottom: 10px; width: 100%; text-align: center; font-size: 14px; color: gray;">
    만든이 : 갱생짐인<br>
    문의 : insta @yejun0847
</footer>
</html>
 
